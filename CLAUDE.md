# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Godot 4.5 RPG** game project using the GL Compatibility renderer.

## Development Commands

This project uses the Godot Editor directly. No external build tools required.

- **Open project**: Launch Godot Editor and open this folder
- **Run game**: Press F5 in Godot Editor (or Scene > Run)
- **Run current scene**: Press F6

## Godot-Specific Guidance

- Scripts use **GDScript** (.gd files)
- Scenes are stored as **.tscn** files (text-based scene format)
- Resources use **.tres** files (text-based resource format)
- All paths in Godot use `res://` prefix (e.g., `res://scenes/player.tscn`)
- The `.godot/` directory is auto-generated cache - never edit manually

## Architecture

### Autoloads (scripts/autoload/)
- **GameManager**: Character/party CRUD, active party tracking, save/load via InstanceRegistry
- **TimeMgr**: Calendar system (12 months x 30 days), time spending, month advancement
- **LocationMgr**: Location graph management, movement requests, discovery
- **CombatMgr**: Turn-based combat state machine (INACTIVE/SELECTING_FORM/EXECUTING/ENEMY_TURN/RESOLVED)

### Data Models (scripts/models/)
- **PlayableCharacter**: Extends RegisteredObject, holds stats/forms/notes/location/days_remaining
- **Party**: Extends RegisteredObject, holds member_ids array and current_location_id
- **Location**: Location graph node with path-like IDs, discovery state, position, is_instant_travel
- **LocationLink**: Undirected edge with travel_distance (days)
- **CombatForm**: Sequence of CombatActions with form_name and description
- **CombatAction**: ActionType enum (ATTACK/DEFEND/SKILL/ITEM), TargetType, power
- **CombatReport**: Outcome enum (WIN/LOSS/FLED), damage stats, turns taken
- **ActionLogEntry**: Character history entries with month/day/description

### UI Scenes (scenes/)
- **main.tscn**: Root scene, manages title screen vs gameplay
- **title_screen.tscn**: New Game / Continue / Exit menu
- **game_view.tscn**: Gameplay container with LocationView, HUD, MoveConfirmation
- **location/location_view.tscn**: DraggableCamera2D map with LocationNode instances
- **location/location_node.tscn**: Clickable location icon with name/exploration labels
- **ui/move_confirmation.tscn**: Travel confirmation dialog

### Key Libraries (lib/)
- **godot-save-system**: SaveSystem.save_game(), LoadSystem.load_object(), GenericSerializer
- **godot-draggable-camera-2d**: DraggableCamera2D with add_content() for zoomable viewports

## Gameplay

- Uses Dialogue Manager plugin for dialogue
- Major game components:
	- LocationMgr: Contains global signals and methods for managing locations
		- moved_to_location(character, old_location, new_location)
	- Location: Contains an undirected graph of LocationLinks, with a 'distance' measurement
	  indicating how much time will be spent travelling. Uses path-like IDs with backslash separators:
	  - `World Map\Small Village` = viewing Small Village as a node (standing outside)
	  - `World Map\Small Village\` = inside Small Village (trailing slash = inside)
	  - `World Map\Small Village\Tavern` = viewing Tavern node from inside Small Village
	  - Top-level locations (depth 0-1): is_instant_travel=false, must walk between nodes with pathfinding
	  - Nested locations (depth 2+): is_instant_travel=true by default, click to enter directly
	  - Instant-travel areas: No links needed, no pathfinding. Exit nodes (Travel/Leave) auto-generated by LocationView
	  - Non-instant areas: Movement with distance > 0 requires confirmation dialog
	  The location is rendered with a DraggableCamera2D over a location-specific background image.
	  A location may be discovered or undiscovered by default. If undiscovered, the icon/label and any links associated with this location are not rendered.
	- LocationLink: An icon, label, and location. When clicked on, a LocationMgr event is triggered.
	- Parties:
		- The player can control one party at a time.
		- A party is composed of one or more PlayableCharacters.
		- The player may switch parties at any time.
		- If a party uses time on activities, the remaining time for every character in the party is reduced.
		- If an activity would reduce any of the party member's available time below zero, it can't be performed.
		- The active party can remove any character, in which case they become a 1-character party. The last character in a party can't be removed, except when that character is being added to the active party. When a party is empty, it is deleted.
	- PlayableCharacter: A character which a player can take control over. Each has their own set of stats, skills, combat forms, etc.
		- Characters each have their own set of 'notes' that can be updated by the current player at any time.
		- When switching parties, the player is first asked if they want to update the notes for any character in their party, and then shown the previously saved notes for the character they switched to.
		- A button can be pressed to show the list of parties, how much time they have left to spend, and to view their recent important actions log.
		- Each PlayableCharacter has a current location, and a list of characters in that location is rendered next to each LocationLink.
	- Combat: 
		- Combat is turn-based. 
		- The player's party is visualized on the right side of the screen as an image, and the enemy on the left. 
		- A command bar is on the bottom of the screen, containing the actions the player can take this turn.
		- Each party has a set of "Combat Forms" they can choose from, and each team selects one of their sequences for the current turn.
		- The "Change Combat Form" command allows the user to select from a list of forms they have previously configured.
		- The "Flee" command allows the user to retreat from the fight.
		- A combat form is a sequence of actions.
		- After combat completes, a CombatReport object is produced which has details on the amount of damage done by each side, whether the player won/lost/fled, etc.
		  This may affect the outcome of whatever location-specific action triggered combat.
	- Time:
		- Time is divided into 12 months with 30 days each.
		- All characters start a new month with 30 days worth of time to spend. Upon using up all the time, they are informed that they'll have to either switch characters, or proceed to the next month.
		- When the month passes, the 'remaining days' counter for all characters is reset.
		- Each character has a log of important actions they took (combat won/lost, etc), with month and a text description. 
	- Tooltips:
		- The game will be heavy on tooltip use, and should have an easy to use system for attaching tooltips to buttons and icons.

## Claude-specific rules

- Claude will CLAUDE.md as changes are made
- Claude will follow KISS and YAGNI principles, avoiding unnecessary complexity.
- When a suggested change goes strongly against best practices, Claude will suggest alternatives.
